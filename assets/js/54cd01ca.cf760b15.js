"use strict";(self.webpackChunkbacalhau_docs=self.webpackChunkbacalhau_docs||[]).push([[657],{5065:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>r,contentTitle:()=>l,default:()=>u,frontMatter:()=>s,metadata:()=>o,toc:()=>c});var i=a(5893),t=a(1151);const s={sidebar_label:"Job Templates",sidebar_position:0,title:"Job Templates",description:"Templating Support in Bacalhau Job Run"},l=void 0,o={id:"topic-guides/job-templating",title:"Job Templates",description:"Templating Support in Bacalhau Job Run",source:"@site/docs/topic-guides/job-templating.md",sourceDirName:"topic-guides",slug:"/topic-guides/job-templating",permalink:"/topic-guides/job-templating",draft:!1,unlisted:!1,editUrl:"https://github.com/bacalhau-project/docs.bacalhau.org/blob/main/docs/topic-guides/job-templating.md",tags:[],version:"current",lastUpdatedAt:1702302289,formattedLastUpdatedAt:"Dec 11, 2023",sidebarPosition:0,frontMatter:{sidebar_label:"Job Templates",sidebar_position:0,title:"Job Templates",description:"Templating Support in Bacalhau Job Run"},sidebar:"documentationSidebar",previous:{title:"Topic Guides",permalink:"/topic-guides"},next:{title:"Job Types",permalink:"/topic-guides/job-types"}},r={},c=[{value:"Overview",id:"overview",level:2},{value:"Motivation",id:"motivation",level:2},{value:"Templating Implementation",id:"templating-implementation",level:2},{value:"Usage Examples",id:"usage-examples",level:2},{value:"Sample Job Spec (job.yaml)",id:"sample-job-spec-jobyaml",level:3},{value:"Running with Templating:",id:"running-with-templating",level:3},{value:"Defining Flag Multiple Times:",id:"defining-flag-multiple-times",level:3},{value:"Disabling Templating:",id:"disabling-templating",level:3},{value:"Using Environment Variables:",id:"using-environment-variables",level:3},{value:"Passing A Subset of Environment Variables:",id:"passing-a-subset-of-environment-variables",level:3},{value:"Dry Run to Preview Templated Spec:",id:"dry-run-to-preview-templated-spec",level:3},{value:"More Examples",id:"more-examples",level:2},{value:"Query Live Logs",id:"query-live-logs",level:3},{value:"Query S3 Logs",id:"query-s3-logs",level:3}];function d(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",p:"p",pre:"pre",...(0,t.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsxs)(n.p,{children:["This documentation introduces templating support for ",(0,i.jsx)(n.a,{href:"/references/cli/job/run",children:(0,i.jsx)(n.code,{children:"bacalhau job run"})}),", providing users with the ability to dynamically inject variables into their job specifications. This feature is particularly useful when running multiple jobs with varying parameters such as DuckDB query, S3 buckets, prefixes, and time ranges without the need to edit each job specification file manually."]}),"\n",(0,i.jsx)(n.h2,{id:"motivation",children:"Motivation"}),"\n",(0,i.jsx)(n.p,{children:"The motivation behind this feature arises from the need to streamline the process of preparing and running multiple jobs with different configurations. Rather than manually editing job specs for each run, users can leverage placeholders and pass actual values at runtime."}),"\n",(0,i.jsx)(n.h2,{id:"templating-implementation",children:"Templating Implementation"}),"\n",(0,i.jsxs)(n.p,{children:["The templating functionality in Bacalhau is built upon the Go ",(0,i.jsx)(n.code,{children:"text/template"})," package. This powerful library offers a wide range of features for manipulating and formatting text based on template definitions and input variables."]}),"\n",(0,i.jsxs)(n.p,{children:["For more detailed information about the Go ",(0,i.jsx)(n.code,{children:"text/template"})," library and its syntax, please refer to the official documentation: ",(0,i.jsxs)(n.a,{href:"https://pkg.go.dev/text/template",children:["Go ",(0,i.jsx)(n.code,{children:"text/template"})," Package"]}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"usage-examples",children:"Usage Examples"}),"\n",(0,i.jsx)(n.h3,{id:"sample-job-spec-jobyaml",children:"Sample Job Spec (job.yaml)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"Name: docker job\nType: batch\nCount: 1\nTasks:\n  - Name: main\n    Engine:\n      Type: docker\n      Params:\n        Image: ubuntu:latest\n        Entrypoint:\n          - /bin/bash\n        Parameters:\n          - -c\n          - echo {{.greeting}} {{.name}}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"running-with-templating",children:"Running with Templating:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'bacalhau job run job.yaml --template-vars "greeting=Hello,name=World"\n'})}),"\n",(0,i.jsx)(n.h3,{id:"defining-flag-multiple-times",children:"Defining Flag Multiple Times:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'bacalhau job run job.yaml --template-vars "greeting=Hello" --template-vars "name=World"\n'})}),"\n",(0,i.jsx)(n.h3,{id:"disabling-templating",children:"Disabling Templating:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"bacalhau job run job.yaml --no-template\n"})}),"\n",(0,i.jsx)(n.h3,{id:"using-environment-variables",children:"Using Environment Variables:"}),"\n",(0,i.jsx)(n.p,{children:"You can also use environment variables for templating:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'export greeting=Hello\nexport name=World\nbacalhau job run job.yaml --template-envs "*"\n'})}),"\n",(0,i.jsx)(n.h3,{id:"passing-a-subset-of-environment-variables",children:"Passing A Subset of Environment Variables:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'bacalhau job run job.yaml --template-envs "greeting|name"\n'})}),"\n",(0,i.jsx)(n.h3,{id:"dry-run-to-preview-templated-spec",children:"Dry Run to Preview Templated Spec:"}),"\n",(0,i.jsxs)(n.p,{children:["To preview the final templated job spec without actually submitting the job, you can use the ",(0,i.jsx)(n.code,{children:"--dry-run"})," flag:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'bacalhau job run job.yaml --template-vars "greeting=Hello,name=World" --dry-run\n'})}),"\n",(0,i.jsx)(n.p,{children:"This will output the processed job specification, showing you how the placeholders have been replaced with the provided values."}),"\n",(0,i.jsx)(n.h2,{id:"more-examples",children:"More Examples"}),"\n",(0,i.jsx)(n.h3,{id:"query-live-logs",children:"Query Live Logs"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'Name: Live logs processing\nType: ops\nTasks:\n  - Name: main\n    Engine:\n      Type: docker\n      Params:\n        Image: expanso/nginx-access-log-processor:1.0.0\n        Parameters:\n          - --query\n          - {{.query}}\n          - --start-time\n          - {{or (index . "start-time") ""}}\n          - --end-time\n          - {{or (index . "end-time") ""}}\n    InputSources:\n      - Target: /logs\n        Source:\n          Type: localDirectory\n          Params:\n            SourcePath: /data/log-orchestration/logs\n'})}),"\n",(0,i.jsxs)(n.p,{children:["This is an ",(0,i.jsx)(n.code,{children:"ops"})," job that runs on all nodes that match the job selection criteria. It accepts duckdb ",(0,i.jsx)(n.code,{children:"query"})," variable, and two optional ",(0,i.jsx)(n.code,{children:"start-time"})," and ",(0,i.jsx)(n.code,{children:"end-time"})," variables to define the time range for the query."]}),"\n",(0,i.jsx)(n.p,{children:"To run this job, you can use the following command:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'bacalhau job run job.yaml \\\n  -V "query=SELECT status FROM logs WHERE status LIKE \'5__\'" \\\n  -V "start-time=-5m" \n'})}),"\n",(0,i.jsx)(n.h3,{id:"query-s3-logs",children:"Query S3 Logs"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'Name: S3 logs processing\nType: batch\nCount: 1\nTasks:\n  - Name: main\n    Engine:\n      Type: docker\n      Params:\n        Image: expanso/nginx-access-log-processor:1.0.0\n        Parameters:\n          - --query\n          - {{.query}}\n    InputSources:\n      - Target: /logs\n        Source:\n          Type: s3\n          Params:\n            Bucket: {{.AccessLogBucket}}\n            Key: {{.AccessLogPrefix}}\n            Filter: {{or (index . "AccessLogPattern") ".*"}}\n            Region: {{.AWSRegion}}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["This is a ",(0,i.jsx)(n.code,{children:"batch"})," job that runs on a single node. It accepts duckdb ",(0,i.jsx)(n.code,{children:"query"})," variable, and four other variables to define the S3 bucket, prefix, pattern for the logs and the AWS region."]}),"\n",(0,i.jsx)(n.p,{children:"To run this job, you can use the following command:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'bacalhau job run job.yaml  \\\n    -V "AccessLogBucket=my-bucket" \\ \n    -V "AWSRegion=us-east-1" \\\n    -V "AccessLogPrefix=2023-11-19-*"  \\\n    -V "AccessLogPattern=^[10-12].*"\n'})})]})}function u(e={}){const{wrapper:n}={...(0,t.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},1151:(e,n,a)=>{a.d(n,{Z:()=>o,a:()=>l});var i=a(7294);const t={},s=i.createContext(t);function l(e){const n=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);