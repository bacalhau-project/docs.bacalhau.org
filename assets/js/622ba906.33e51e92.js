"use strict";(self.webpackChunkbacalhau_docs=self.webpackChunkbacalhau_docs||[]).push([[88],{2571:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>h,frontMatter:()=>a,metadata:()=>s,toc:()=>d});var t=o(5893),r=o(1151);const a={sidebar_label:"Onboard Docker Workload",sidebar_position:3,description:"How to use docker containers with Bacalhau"},i="Onboarding Your Docker Workloads",s={id:"getting-started/docker-workload-onboarding",title:"Onboarding Your Docker Workloads",description:"How to use docker containers with Bacalhau",source:"@site/docs/getting-started/docker-workload-onboarding.md",sourceDirName:"getting-started",slug:"/getting-started/docker-workload-onboarding",permalink:"/getting-started/docker-workload-onboarding",draft:!1,unlisted:!1,editUrl:"https://github.com/bacalhau-project/docs.bacalhau.org/blob/main/docs/getting-started/docker-workload-onboarding.md",tags:[],version:"current",lastUpdatedAt:1701669642,formattedLastUpdatedAt:"Dec 4, 2023",sidebarPosition:3,frontMatter:{sidebar_label:"Onboard Docker Workload",sidebar_position:3,description:"How to use docker containers with Bacalhau"},sidebar:"documentationSidebar",previous:{title:"Installation",permalink:"/getting-started/installation"},next:{title:"Onboard WebAssembly Workload",permalink:"/getting-started/wasm-workload-onboarding"}},l={},d=[{value:"Requirements",id:"requirements",level:2},{value:"Runtime Restrictions",id:"runtime-restrictions",level:2},{value:"Onboarding Your Workload",id:"onboarding-your-workload",level:2},{value:"Step 1 - Read Data From Your Directory",id:"step-1---read-data-from-your-directory",level:3},{value:"Step 2 - Write Data to the Your Directory",id:"step-2---write-data-to-the-your-directory",level:3},{value:"Step 3 - Build and Push Your Image To a Registry",id:"step-3---build-and-push-your-image-to-a-registry",level:3},{value:"Step 4 - Test Your Container",id:"step-4---test-your-container",level:3},{value:"Step 5 - Upload the Input Data",id:"step-5---upload-the-input-data",level:3},{value:"Step 6 - Run the Workload on Bacalhau",id:"step-6---run-the-workload-on-bacalhau",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Support",id:"support",level:2}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"onboarding-your-docker-workloads",children:"Onboarding Your Docker Workloads"}),"\n",(0,t.jsx)(n.p,{children:"Bacalhau executes jobs by running them within containers. This section describes how to migrate a workload based on a Docker container into a format that will work with the Bacalhau client."}),"\n",(0,t.jsx)(n.admonition,{type:"tip",children:(0,t.jsxs)(n.p,{children:["You can check out this example tutorial on ",(0,t.jsx)(n.a,{href:"https://docs.bacalhau.org/examples/workload-onboarding/custom-containers/",children:"how to work with custom containers in Bacalhau"})," to see how we used all these steps together."]})}),"\n",(0,t.jsx)(n.h2,{id:"requirements",children:"Requirements"}),"\n",(0,t.jsx)(n.p,{children:"Here are a few things to note before getting started:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"You must publish the container to a public container registry that is accessible from the Bacalhau network"}),"\n",(0,t.jsxs)(n.li,{children:["Bacalhau supports only images that match the architecture of the host node. Typically, most nodes run ",(0,t.jsx)(n.code,{children:"linux/amd64"})," so containers in ",(0,t.jsx)(n.code,{children:"arm64"})," format are not able to run."]}),"\n",(0,t.jsxs)(n.li,{children:["The ",(0,t.jsx)(n.code,{children:"--input ipfs://..."})," flag does not support CID subpaths only ",(0,t.jsx)(n.strong,{children:"directories"})]}),"\n",(0,t.jsxs)(n.li,{children:["The ",(0,t.jsx)(n.code,{children:"--input https://..."})," flag does not support URL directories only ",(0,t.jsx)(n.strong,{children:"single files"})," only"]}),"\n",(0,t.jsxs)(n.li,{children:["The ",(0,t.jsx)(n.code,{children:"--input s3://..."})," flag does support S3 keys and prefixes. e.g. ",(0,t.jsx)(n.code,{children:"s3://bucket/logs-2023-04*"})," for all April 2023 logs"]}),"\n"]}),"\n",(0,t.jsxs)(n.admonition,{type:"tip",children:[(0,t.jsxs)(n.p,{children:["You can check to see a ",(0,t.jsx)(n.a,{href:"https://github.com/orgs/bacalhau-project/packages?repo_name=examples",children:"list of example public containers"})," used by the Bacalhau team"]}),(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Note"}),": Only about a third of examples have their containers here. The rest are under random docker hub registries (mostly Vedants)."]})]}),"\n",(0,t.jsx)(n.h2,{id:"runtime-restrictions",children:"Runtime Restrictions"}),"\n",(0,t.jsx)(n.p,{children:"To help provide a safe, secure network for all users, we add the following runtime restrictions:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["All ingress/egress networking is limited, as described in the ",(0,t.jsx)(n.a,{href:"/next-steps/networking",children:"networking"})," documentation. You won't be able to pull ",(0,t.jsx)(n.code,{children:"data/code/weights/"})," etc from an external source"]}),"\n",(0,t.jsxs)(n.li,{children:["Data passing is implemented with Docker volumes, using ",(0,t.jsx)(n.a,{href:"https://docs.bacalhau.org/about-bacalhau/architecture#input--output-volumes",children:"Bacalhau's input/output volumes"})]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"onboarding-your-workload",children:"Onboarding Your Workload"}),"\n",(0,t.jsx)(n.h3,{id:"step-1---read-data-from-your-directory",children:"Step 1 - Read Data From Your Directory"}),"\n",(0,t.jsx)(n.p,{children:"If you need to pass data into your container you will do this through a Docker volume. You'll need to modify your code to read from a local directory."}),"\n",(0,t.jsxs)(n.p,{children:["We make the assumption that you are reading from a directory called ",(0,t.jsx)(n.code,{children:"/inputs"}),", which is set as the default."]}),"\n",(0,t.jsx)(n.admonition,{type:"tip",children:(0,t.jsxs)(n.p,{children:["You can specify which directory the data is written to with the ",(0,t.jsx)(n.a,{href:"https://docs.bacalhau.org/all-flags#run-python",children:(0,t.jsx)(n.code,{children:"--input"})})," CLI flag."]})}),"\n",(0,t.jsx)(n.h3,{id:"step-2---write-data-to-the-your-directory",children:"Step 2 - Write Data to the Your Directory"}),"\n",(0,t.jsx)(n.p,{children:"If you need to return data from your container you will do this through a Docker volume. You'll need to modify your code to write to a local directory."}),"\n",(0,t.jsxs)(n.p,{children:["We make the assumption that you are writing to a directory called ",(0,t.jsx)(n.code,{children:"/outputs"}),", which is set as the default."]}),"\n",(0,t.jsx)(n.admonition,{type:"tip",children:(0,t.jsxs)(n.p,{children:["You can specify which directory the data is written to with the ",(0,t.jsx)(n.a,{href:"https://docs.bacalhau.org/all-flags#run-python",children:(0,t.jsx)(n.code,{children:"--output-volumes"})})," CLI flag."]})}),"\n",(0,t.jsx)(n.h3,{id:"step-3---build-and-push-your-image-to-a-registry",children:"Step 3 - Build and Push Your Image To a Registry"}),"\n",(0,t.jsxs)(n.p,{children:["If you haven't already, you'll need to ",(0,t.jsx)(n.a,{href:"https://docs.docker.com/engine/reference/commandline/build/",children:"build your image"})," and ",(0,t.jsx)(n.a,{href:"https://docs.docker.com/engine/reference/commandline/push/",children:"push it"})," to a publicly accessible container registry."]}),"\n",(0,t.jsx)(n.admonition,{type:"caution",children:(0,t.jsxs)(n.p,{children:["Most Bacalhau nodes are of an ",(0,t.jsx)(n.code,{children:"x86_64"})," architecture, therefore containers should be built for ",(0,t.jsxs)(n.a,{href:"#what-containers-to-use",children:[(0,t.jsx)(n.code,{children:"x86_64"})," systems"]}),"."]})}),"\n",(0,t.jsx)(n.p,{children:"For example:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"$ export IMAGE=myuser/myimage:latest\n$ docker build -t ${IMAGE} .\n$ docker image push ${IMAGE}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"step-4---test-your-container",children:"Step 4 - Test Your Container"}),"\n",(0,t.jsx)(n.p,{children:"To test your docker image locally, you'll need to execute the following command, changing the environment variables as necessary:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"$ export LOCAL_INPUT_DIR=$PWD\n$ export LOCAL_OUTPUT_DIR=$PWD\n$ export CMD=(sh -c 'ls /inputs; echo do something useful > /outputs/stdout')\n$ docker run --rm \\\n  -v ${LOCAL_INPUT_DIR}:/inputs  \\\n  -v ${LOCAL_OUTPUT_DIR}:/outputs \\\n  ${IMAGE} \\\n  ${CMD}\n"})}),"\n",(0,t.jsx)(n.admonition,{type:"tip",children:(0,t.jsxs)(n.p,{children:["Bacalhau will use the ",(0,t.jsx)(n.a,{href:"https://docs.docker.com/engine/reference/builder/#entrypoint",children:"default ENTRYPOINT"}),"\nif your image contains one. To override it, pass ",(0,t.jsx)(n.code,{children:"--entrypoint"})," to ",(0,t.jsx)(n.code,{children:"bacalhau docker run"}),"."]})}),"\n",(0,t.jsx)(n.p,{children:"For example:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"$ export IMAGE=ubuntu\n$ docker run --rm \\\n  -v ${LOCAL_INPUT_DIR}:/inputs  \\\n  -v ${LOCAL_OUTPUT_DIR}:/outputs \\\n  ${IMAGE} \\\n  ${CMD}\n$ cat stdout\n"})}),"\n",(0,t.jsx)(n.p,{children:"This snippet results in:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"...file listing...\ndo something useful\n"})}),"\n",(0,t.jsx)(n.h3,{id:"step-5---upload-the-input-data",children:"Step 5 - Upload the Input Data"}),"\n",(0,t.jsx)(n.p,{children:"Data is identified by its content identifier (CID) and can be accessed by anyone who knows the CID. You can use either of these methods to upload your data:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://docs.bacalhau.org/data-ingestion/from-url",children:"Copy data from a URL to public storage"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://docs.bacalhau.org/data-ingestion/pin",children:"Pin Data to public storage"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://docs.bacalhau.org/data-ingestion/s3",children:"Copy Data from S3 Bucket to public storage"})}),"\n"]}),"\n",(0,t.jsx)(n.admonition,{type:"info",children:(0,t.jsx)(n.p,{children:"You can mount your data anywhere on your machine, and Bacalhau will be able to run against that data"})}),"\n",(0,t.jsx)(n.h3,{id:"step-6---run-the-workload-on-bacalhau",children:"Step 6 - Run the Workload on Bacalhau"}),"\n",(0,t.jsx)(n.p,{children:"To run your workload, run the following command:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"$ bacalhau docker run --input ipfs://${CID} ${IMAGE} ${CMD}\n"})}),"\n",(0,t.jsx)(n.p,{children:"To check the status of your job, run the following command:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"$ bacalhau list \n"})}),"\n",(0,t.jsx)(n.p,{children:"To get more information on your job"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"$ bacalhau describe JOB_ID\n"})}),"\n",(0,t.jsx)(n.p,{children:"To download your job"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"$ bacalhau get JOB_ID\n"})}),"\n",(0,t.jsx)(n.p,{children:"For example, running:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"$ job_id=$(bacalhau docker run ubuntu echo hello)\n$ bacalhau list --id-filter $job_id\n$ sleep 5\n$ bacalhau list --id-filter $job_id\n$ bacalhau get $job_id\n$ ls shards\n"})}),"\n",(0,t.jsx)(n.p,{children:"outputs:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:" CREATED   ID        JOB                      STATE      VERIFIED  PUBLISHED \n 10:26:00  24440f0d  Docker ubuntu echo h...  Verifying                      \n CREATED   ID        JOB                      STATE      VERIFIED  PUBLISHED               \n 10:26:00  24440f0d  Docker ubuntu echo h...  Published            /ipfs/bafybeiflj3kha... \n11:26:09.107 | INF bacalhau/get.go:67 > Fetching results of job '24440f0d-3c06-46af-9adf-cb524aa43961'...\n11:26:10.528 | INF ipfs/downloader.go:115 > Found 1 result shards, downloading to temporary folder.\n11:26:13.144 | INF ipfs/downloader.go:195 > Combining shard from output volume 'outputs' to final location: '/Users/phil/source/filecoin-project/docs.bacalhau.org'\njob-24440f0d-3c06-46af-9adf-cb524aa43961-shard-0-host-QmYgxZiySj3MRkwLSL4X2MF5F9f2PMhAE3LV49XkfNL1o3\n"})}),"\n",(0,t.jsx)(n.admonition,{type:"caution",children:(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"--input"})," flag does not support CID subpaths for ",(0,t.jsx)(n.code,{children:"ipfs://"})," content."]})}),"\n",(0,t.jsx)(n.p,{children:"Alternatively, you can run your workload with a publicly accessible http(s) URL, which will download the data temporarily into your public storage:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"$ export URL=https://download.geofabrik.de/antarctica-latest.osm.pbf\n$ bacalhau docker run --input ${URL} ${IMAGE} ${CMD}\n\n$ bacalhau list \n\n$ bacalhau get JOB_ID\n"})}),"\n",(0,t.jsx)(n.admonition,{type:"caution",children:(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"--input"})," flag does not support URL directories."]})}),"\n",(0,t.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,t.jsx)(n.p,{children:"If you run into this compute error while running your docker image"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"Creating job for submission ... done \u2705\nFinding node(s) for the job ... done \u2705\nNode accepted the job ... done \u2705\nError while executing the job.\n"})}),"\n",(0,t.jsx)(n.p,{children:"This can often be resolved by re-tagging your docker image"}),"\n",(0,t.jsx)(n.h2,{id:"support",children:"Support"}),"\n",(0,t.jsxs)(n.p,{children:["If have questions or need support or guidance, please reach out to the ",(0,t.jsx)(n.a,{href:"https://bit.ly/bacalhau-project-slack/archives/C02RLM3JHUY",children:"Bacalhau team via Slack"}),"(#bacalhau channel)"]})]})}function h(e={}){const{wrapper:n}={...(0,r.a)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},1151:(e,n,o)=>{o.d(n,{Z:()=>s,a:()=>i});var t=o(7294);const r={},a=t.createContext(r);function i(e){const n=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);