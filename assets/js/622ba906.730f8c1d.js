"use strict";(self.webpackChunkbacalhau_docs=self.webpackChunkbacalhau_docs||[]).push([[88],{2131:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>u,contentTitle:()=>i,default:()=>p,frontMatter:()=>r,metadata:()=>l,toc:()=>s});var o=a(7462),n=(a(7294),a(3905));a(2004);const r={sidebar_label:"Onboard Docker Workload",sidebar_position:2,description:"How to use docker containers with Bacalhau"},i="Onboarding Your Docker Workloads",l={unversionedId:"getting-started/docker-workload-onboarding",id:"getting-started/docker-workload-onboarding",title:"Onboarding Your Docker Workloads",description:"How to use docker containers with Bacalhau",source:"@site/docs/getting-started/docker-workload-onboarding.md",sourceDirName:"getting-started",slug:"/getting-started/docker-workload-onboarding",permalink:"/getting-started/docker-workload-onboarding",draft:!1,editUrl:"https://github.com/bacalhau-project/docs.bacalhau.org/blob/main/docs/getting-started/docker-workload-onboarding.md",tags:[],version:"current",lastUpdatedAt:1677549363,formattedLastUpdatedAt:"Feb 28, 2023",sidebarPosition:2,frontMatter:{sidebar_label:"Onboard Docker Workload",sidebar_position:2,description:"How to use docker containers with Bacalhau"},sidebar:"documentationSidebar",previous:{title:"Installation",permalink:"/getting-started/installation"},next:{title:"Onboard WebAssembly Workload",permalink:"/getting-started/wasm-workload-onboarding"}},u={},s=[{value:"Requirements",id:"requirements",level:2},{value:"Runtime Restrictions",id:"runtime-restrictions",level:2},{value:"Onboarding Your Workload",id:"onboarding-your-workload",level:2},{value:"Step 1 - Read Data From Your Directory",id:"step-1---read-data-from-your-directory",level:3},{value:"Step 2 - Write Data to the Your Directory",id:"step-2---write-data-to-the-your-directory",level:3},{value:"Step 3 - Build and Push Your Image To a Registry",id:"step-3---build-and-push-your-image-to-a-registry",level:3},{value:"Step 4 - Test Your Container",id:"step-4---test-your-container",level:3},{value:"Step 5 - Upload the Input Data",id:"step-5---upload-the-input-data",level:3},{value:"Step 6 - Run the Workload on Bacalhau",id:"step-6---run-the-workload-on-bacalhau",level:3},{value:"Video Tutorials",id:"video-tutorials",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Support",id:"support",level:2}],d={toc:s};function p(e){let{components:t,...a}=e;return(0,n.kt)("wrapper",(0,o.Z)({},d,a,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("h1",{id:"onboarding-your-docker-workloads"},"Onboarding Your Docker Workloads"),(0,n.kt)("p",null,"Bacalhau executes jobs by running them within containers. This sections describes how to migrate a workload based on a Docker container into a format that will work with the Bacalhau client. "),(0,n.kt)("admonition",{type:"tip"},(0,n.kt)("p",{parentName:"admonition"},"You can check out this example tutorial on ",(0,n.kt)("a",{parentName:"p",href:"https://docs.bacalhau.org/examples/workload-onboarding/custom-containers/"},"how to work with custom containers in Bacalhau")," to see how we used all these steps together. ")),(0,n.kt)("h2",{id:"requirements"},"Requirements"),(0,n.kt)("p",null,"Here are some few things to note before getting started:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"You must publish the container to a public container registry that is accessible from the Bacalhau network"),(0,n.kt)("li",{parentName:"ul"},"Bacalhau supports only ",(0,n.kt)("inlineCode",{parentName:"li"},"amd64")," images. Does not support ",(0,n.kt)("inlineCode",{parentName:"li"},"arm64")," images"),(0,n.kt)("li",{parentName:"ul"},"Containers must have an ",(0,n.kt)("inlineCode",{parentName:"li"},"x86_64")," CPU architecture"),(0,n.kt)("li",{parentName:"ul"},"The ",(0,n.kt)("inlineCode",{parentName:"li"},"--inputs")," and ",(0,n.kt)("inlineCode",{parentName:"li"},"--input-volumes")," flags do not support CID subpaths only ",(0,n.kt)("strong",{parentName:"li"},"directories")," "),(0,n.kt)("li",{parentName:"ul"},"The ",(0,n.kt)("inlineCode",{parentName:"li"},"--input-urls")," flag does not support URL directories only ",(0,n.kt)("strong",{parentName:"li"},"single files")," only")),(0,n.kt)("admonition",{type:"tip"},(0,n.kt)("p",{parentName:"admonition"},"You can check to see a ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/orgs/bacalhau-project/packages?repo_name=examples"},"list of example public containers")," used by the Bacalhau team"),(0,n.kt)("p",{parentName:"admonition"},(0,n.kt)("strong",{parentName:"p"},"Note"),": Only about a third of examples have their containers here. The rest are under random docker hub registries (mostly Vedants).")),(0,n.kt)("h2",{id:"runtime-restrictions"},"Runtime Restrictions"),(0,n.kt)("p",null,"To help provide a safe, secure network for all users, we add the following runtime restrictions:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"All ingress/egress networking is disabled. You won't be able to pull ",(0,n.kt)("inlineCode",{parentName:"li"},"data/code/weights/")," etc from an external source"),(0,n.kt)("li",{parentName:"ul"},"Data passing is implemented with Docker volumes, using ",(0,n.kt)("a",{parentName:"li",href:"https://docs.bacalhau.org/about-bacalhau/architecture#input--output-volumes"},"Bacalhau's input/output volumes"))),(0,n.kt)("h2",{id:"onboarding-your-workload"},"Onboarding Your Workload"),(0,n.kt)("h3",{id:"step-1---read-data-from-your-directory"},"Step 1 - Read Data From Your Directory"),(0,n.kt)("p",null,"If you need to pass data into your container you will do this through a Docker volume. You'll need to modify your code to read from a local directory."),(0,n.kt)("p",null,"We make the assumption that you are reading from a directory called ",(0,n.kt)("inlineCode",{parentName:"p"},"/inputs"),", which is set as the default."),(0,n.kt)("admonition",{type:"tip"},(0,n.kt)("p",{parentName:"admonition"},"You can specify which directory the data is written to with the ",(0,n.kt)("a",{parentName:"p",href:"https://docs.bacalhau.org/all-flags#run-python"},(0,n.kt)("inlineCode",{parentName:"a"},"--input-volumes"))," CLI flag.")),(0,n.kt)("h3",{id:"step-2---write-data-to-the-your-directory"},"Step 2 - Write Data to the Your Directory"),(0,n.kt)("p",null,"If you need to return data from your container you will do this through a Docker volume. You'll need to modify your code to write to a local directory."),(0,n.kt)("p",null,"We make the assumption that you are writing to a directory called ",(0,n.kt)("inlineCode",{parentName:"p"},"/outputs"),", which is set as the default."),(0,n.kt)("admonition",{type:"tip"},(0,n.kt)("p",{parentName:"admonition"},"You can specify which directory the data is written to with the ",(0,n.kt)("a",{parentName:"p",href:"https://docs.bacalhau.org/all-flags#run-python"},(0,n.kt)("inlineCode",{parentName:"a"},"--output-volumes"))," CLI flag.")),(0,n.kt)("h3",{id:"step-3---build-and-push-your-image-to-a-registry"},"Step 3 - Build and Push Your Image To a Registry"),(0,n.kt)("p",null,"If you haven't already, you'll need to ",(0,n.kt)("a",{parentName:"p",href:"https://docs.docker.com/engine/reference/commandline/build/"},"build your image")," and ",(0,n.kt)("a",{parentName:"p",href:"https://docs.docker.com/engine/reference/commandline/push/"},"push it")," to a publicly accessible container registry."),(0,n.kt)("admonition",{type:"caution"},(0,n.kt)("p",{parentName:"admonition"},"All Bacalhau nodes are of an ",(0,n.kt)("inlineCode",{parentName:"p"},"x86_64")," architecture, therefore containers must be built for ",(0,n.kt)("a",{parentName:"p",href:"#what-containers-to-use"},(0,n.kt)("inlineCode",{parentName:"a"},"x86_64")," systems"),".")),(0,n.kt)("p",null,"For example:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"$ export IMAGE=myuser/myimage:latest\n$ docker build -t ${IMAGE} .\n$ docker image push ${IMAGE}\n")),(0,n.kt)("h3",{id:"step-4---test-your-container"},"Step 4 - Test Your Container"),(0,n.kt)("p",null,"To test your docker image locally, you'll need to execute the following command, changing the environment variables as necessary:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"$ export LOCAL_INPUT_DIR=$PWD\n$ export LOCAL_OUTPUT_DIR=$PWD\n$ export CMD=(sh -c 'ls /inputs; echo do something useful > /outputs/stdout')\n$ docker run --rm \\\n  -v ${LOCAL_INPUT_DIR}:/inputs  \\\n  -v ${LOCAL_OUTPUT_DIR}:/outputs \\\n  ${IMAGE} \\\n  ${CMD}\n")),(0,n.kt)("p",null,"For example:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"$ export IMAGE=ubuntu\n$ docker run --rm \\\n  -v ${LOCAL_INPUT_DIR}:/inputs  \\\n  -v ${LOCAL_OUTPUT_DIR}:/outputs \\\n  ${IMAGE} \\\n  ${CMD}\n$ cat stdout\n")),(0,n.kt)("p",null,"This snippet results in:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"...file listing...\ndo something useful\n")),(0,n.kt)("h3",{id:"step-5---upload-the-input-data"},"Step 5 - Upload the Input Data"),(0,n.kt)("p",null,"We recommend uploading your data to IPFS for persistent storage, because:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Bacalhau is designed to perform the computation next to the data"),(0,n.kt)("li",{parentName:"ul"},"Distributing data across the solar system with IPFS distributes the Bacalhau computation"),(0,n.kt)("li",{parentName:"ul"},"Distributing computation improves performance by scaling, and improves resiliency via redundancy"),(0,n.kt)("li",{parentName:"ul"},"Using IPFS CIDs as inputs enables repeatable and cacheable execution")),(0,n.kt)("admonition",{type:"tip"},(0,n.kt)("p",{parentName:"admonition"},"The following guides explain how to store data on the IPFS network."),(0,n.kt)("ul",{parentName:"admonition"},(0,n.kt)("li",{parentName:"ul"},"Leverage an IPFS \u201cpinning service\u201d such as:",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://web3.storage/account/"},"Web3.Storage")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://estuary.tech/sign-in"},"Estuary")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://docs.ipfs.io/how-to/pin-files/"},"Manually pin your files to IPFS")," with your own IPFS server."))),(0,n.kt)("li",{parentName:"ul"},"If uploading a folder of input files, consider ",(0,n.kt)("a",{parentName:"li",href:"https://web3.storage/docs/#create-the-upload-script"},"uploading with this script"),". However, please note that any content uploaded to Web3.storage is ",(0,n.kt)("a",{parentName:"li",href:"https://web3.storage/docs/how-tos/store/#directory-wrapping"},"also wrapped in a parent directory"),". You will need to take care to reference the inner directory CID in your bacalhau command."))),(0,n.kt)("h3",{id:"step-6---run-the-workload-on-bacalhau"},"Step 6 - Run the Workload on Bacalhau"),(0,n.kt)("p",null,"To run your workload using input data stored in IPFS, run the following command:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"$ bacalhau docker run --inputs ${CID} ${IMAGE} ${CMD}\n\n$ bacalhau list \n\n$ bacalhau get JOB_ID\n")),(0,n.kt)("p",null,"For example, running:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"$ job_id=$(bacalhau docker run ubuntu echo hello)\n$ bacalhau list --id-filter $job_id\n$ sleep 5\n$ bacalhau list --id-filter $job_id\n$ bacalhau get $job_id\n$ ls shards\n")),(0,n.kt)("p",null,"outputs:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"}," CREATED   ID        JOB                      STATE      VERIFIED  PUBLISHED \n 10:26:00  24440f0d  Docker ubuntu echo h...  Verifying                      \n CREATED   ID        JOB                      STATE      VERIFIED  PUBLISHED               \n 10:26:00  24440f0d  Docker ubuntu echo h...  Published            /ipfs/bafybeiflj3kha... \n11:26:09.107 | INF bacalhau/get.go:67 > Fetching results of job '24440f0d-3c06-46af-9adf-cb524aa43961'...\n11:26:10.528 | INF ipfs/downloader.go:115 > Found 1 result shards, downloading to temporary folder.\n11:26:13.144 | INF ipfs/downloader.go:195 > Combining shard from output volume 'outputs' to final location: '/Users/phil/source/filecoin-project/docs.bacalhau.org'\njob-24440f0d-3c06-46af-9adf-cb524aa43961-shard-0-host-QmYgxZiySj3MRkwLSL4X2MF5F9f2PMhAE3LV49XkfNL1o3\n")),(0,n.kt)("admonition",{type:"caution"},(0,n.kt)("p",{parentName:"admonition"},"The ",(0,n.kt)("inlineCode",{parentName:"p"},"--inputs")," flag does not support CID subpaths.")),(0,n.kt)("p",null,"Alternatively, you can run your workload with a publicly accessible http(s) URL, which will download the data temporarily into IPFS:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"$ export URL=https://download.geofabrik.de/antarctica-latest.osm.pbf\n$ bacalhau docker run --input-urls ${URL}:/inputs ${IMAGE} ${CMD}\n\n$ bacalhau list \n\n$ bacalhau get JOB_ID\n")),(0,n.kt)("admonition",{type:"caution"},(0,n.kt)("p",{parentName:"admonition"},"The ",(0,n.kt)("inlineCode",{parentName:"p"},"--input-urls")," flag does not support URL directories.")),(0,n.kt)("h2",{id:"video-tutorials"},"Video Tutorials"),(0,n.kt)("p",null,"We have video tutorial examples on how to onboarded workload to Bacalhau:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://www.youtube.com/watch?v=t2AHD8yJhLY"},"Youtube: Bacalhau SOCAT Workload Demo")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/wesfloyd/bacalhau_socat_test"},"Github: bacalhau_socat_test")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://www.youtube.com/watch?v=wkOh05J5qgA"},"Youtube: Bacalhau Intro Video"))),(0,n.kt)("h2",{id:"troubleshooting"},"Troubleshooting"),(0,n.kt)("p",null,"If you run into this compute error while running your docker image "),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"Creating job for submission ... done \u2705\nFinding node(s) for the job ... done \u2705\nNode accepted the job ... done \u2705\nError while executing the job.\n")),(0,n.kt)("p",null,"This can often be resolved by re-tagging your docker image"),(0,n.kt)("h2",{id:"support"},"Support"),(0,n.kt)("p",null,"Please reach out to the ",(0,n.kt)("a",{parentName:"p",href:"https://filecoinproject.slack.com/archives/C02RLM3JHUY"},"Bacalhau team via Slack")," if you would like help pinning data to IPFS for your job or for any issues you encounter."))}p.isMDXComponent=!0}}]);