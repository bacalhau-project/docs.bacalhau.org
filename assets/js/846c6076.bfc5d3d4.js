"use strict";(self.webpackChunkbacalhau_docs=self.webpackChunkbacalhau_docs||[]).push([[1410],{3905:(e,t,a)=>{a.d(t,{Zo:()=>d,kt:()=>m});var n=a(7294);function o(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){o(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,o=function(e,t){if(null==e)return{};var a,n,o={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(o[a]=e[a]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},d=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},c=n.forwardRef((function(e,t){var a=e.components,o=e.mdxType,r=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),c=p(a),m=o,h=c["".concat(s,".").concat(m)]||c[m]||u[m]||r;return a?n.createElement(h,i(i({ref:t},d),{},{components:a})):n.createElement(h,i({ref:t},d))}));function m(e,t){var a=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=a.length,i=new Array(r);i[0]=c;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:o,i[1]=l;for(var p=2;p<r;p++)i[p]=a[p];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}c.displayName="MDXCreateElement"},3635:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>u,frontMatter:()=>r,metadata:()=>l,toc:()=>p});var n=a(7462),o=(a(7294),a(3905));const r={sidebar_label:"Simple Parallel Workloads",sidebar_position:2,description:"Parallel Video Resizing via File Sharding"},i="Parallel Video Resizing via File Sharding",l={unversionedId:"examples/data-engineering/simple-parallel-workloads/index",id:"examples/data-engineering/simple-parallel-workloads/index",title:"Parallel Video Resizing via File Sharding",description:"Parallel Video Resizing via File Sharding",source:"@site/docs/examples/data-engineering/simple-parallel-workloads/index.md",sourceDirName:"examples/data-engineering/simple-parallel-workloads",slug:"/examples/data-engineering/simple-parallel-workloads/",permalink:"/examples/data-engineering/simple-parallel-workloads/",draft:!1,editUrl:"https://github.com/bacalhau-project/docs.bacalhau.org/blob/main/docs/examples/data-engineering/simple-parallel-workloads/index.md",tags:[],version:"current",lastUpdatedAt:1675339927,formattedLastUpdatedAt:"Feb 2, 2023",sidebarPosition:2,frontMatter:{sidebar_label:"Simple Parallel Workloads",sidebar_position:2,description:"Parallel Video Resizing via File Sharding"},sidebar:"documentationSidebar",previous:{title:"Simple Image Processing",permalink:"/examples/data-engineering/image-processing/"},next:{title:"Ethereum Blockchain Analysis",permalink:"/examples/data-engineering/blockchain-etl/"}},s={},p=[{value:"Prerequistes",id:"prerequistes",level:2},{value:"Submit the workload",id:"submit-the-workload",level:2},{value:"A Simple Video Resize Example",id:"a-simple-video-resize-example",level:3},{value:"Get Results",id:"get-results",level:2}],d={toc:p};function u(e){let{components:t,...r}=e;return(0,o.kt)("wrapper",(0,n.Z)({},d,r,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"parallel-video-resizing-via-file-sharding"},"Parallel Video Resizing via File Sharding"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://colab.research.google.com/github/bacalhau-project/examples/blob/main/data-engineering/simple-parallel-workloads/index.ipynb"},(0,o.kt)("img",{parentName:"a",src:"https://colab.research.google.com/assets/colab-badge.svg",alt:"Open In Colab"})),"\n",(0,o.kt)("a",{parentName:"p",href:"https://mybinder.org/v2/gh/bacalhau-project/examples/HEAD?labpath=data-engineering%2Fsimple-parallel-workloads%2Findex.ipynb"},(0,o.kt)("img",{parentName:"a",src:"https://mybinder.org/badge.svg",alt:"Open In Binder"}))),(0,o.kt)("p",null,"Many data engineering workloads consist of embarrassingly parallel workloads where you want to run a simple execution on a large number of files. In this notebook, we will use the ",(0,o.kt)("a",{parentName:"p",href:"https://docs.bacalhau.org/getting-started/parallel-workloads"},"Sharding")," functionality in Bacalhau to run a simple video filter on a large number of video files."),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"Although you would normally you would use your own container and script to make your workloads reproducible, in this example we will use a pre-built container and CLI arguments to allow you to make changes. You can find the container ",(0,o.kt)("a",{parentName:"p",href:"https://hub.docker.com/r/linuxserver/ffmpeg"},"on docker hub"),".")),(0,o.kt)("h2",{id:"prerequistes"},"Prerequistes"),(0,o.kt)("p",null,"Make sure you have the latest ",(0,o.kt)("inlineCode",{parentName:"p"},"bacalhau")," client installed by following the ",(0,o.kt)("a",{parentName:"p",href:"../../../getting-started/installation"},"getting started instructions")," or using the installation command below (which installs Bacalhau local to the notebook)."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},"!command -v bacalhau >/dev/null 2>&1 || (export BACALHAU_INSTALL_DIR=.; curl -sL https://get.bacalhau.org/install.sh | bash)\npath=!echo $PATH\n%env PATH=./:{path[0]}\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"Your system is linux_amd64\nNo BACALHAU detected. Installing fresh BACALHAU CLI...\nGetting the latest BACALHAU CLI...\nInstalling v0.3.15 BACALHAU CLI...\nDownloading https://github.com/filecoin-project/bacalhau/releases/download/v0.3.15/bacalhau_v0.3.15_linux_amd64.tar.gz ...\nDownloading sig file https://github.com/filecoin-project/bacalhau/releases/download/v0.3.15/bacalhau_v0.3.15_linux_amd64.tar.gz.signature.sha256 ...\nVerified OK\nExtracting tarball ...\nNOT verifying Bin\nbacalhau installed into . successfully.\nClient Version: v0.3.15\nServer Version: v0.3.15\nenv: PATH=./:/home/gitpod/.pyenv/versions/3.8.13/bin:/home/gitpod/.pyenv/libexec:/home/gitpod/.pyenv/plugins/python-build/bin:/home/gitpod/.pyenv/plugins/pyenv-virtualenv/bin:/home/gitpod/.pyenv/plugins/pyenv-update/bin:/home/gitpod/.pyenv/plugins/pyenv-installer/bin:/home/gitpod/.pyenv/plugins/pyenv-doctor/bin:/home/gitpod/.pyenv/shims:/ide/bin/remote-cli:/home/gitpod/.nix-profile/bin:/home/gitpod/.local/bin:/home/gitpod/.sdkman/candidates/maven/current/bin:/home/gitpod/.sdkman/candidates/java/current/bin:/home/gitpod/.sdkman/candidates/gradle/current/bin:/workspace/.cargo/bin:/home/gitpod/.rvm/gems/ruby-3.1.2/bin:/home/gitpod/.rvm/gems/ruby-3.1.2@global/bin:/home/gitpod/.rvm/rubies/ruby-3.1.2/bin:/home/gitpod/.pyenv/plugins/pyenv-virtualenv/shims:/home/gitpod/.pyenv/shims:/workspace/go/bin:/home/gitpod/.nix-profile/bin:/ide/bin/remote-cli:/home/gitpod/go/bin:/home/gitpod/go-packages/bin:/home/gitpod/.nvm/versions/node/v16.19.0/bin:/home/gitpod/.yarn/bin:/home/gitpod/.pnpm:/home/gitpod/.pyenv/bin:/workspace/.rvm/bin:/home/gitpod/.cargo/bin:/home/linuxbrew/.linuxbrew/bin:/home/linuxbrew/.linuxbrew/sbin/:/home/gitpod/.local/bin:/usr/games:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/home/gitpod/.nvm/versions/node/v16.19.0/bin:/home/gitpod/.rvm/bin\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"bacalhau version\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"Client Version: v0.3.15\nServer Version: v0.3.15\n")),(0,o.kt)("h2",{id:"submit-the-workload"},"Submit the workload"),(0,o.kt)("p",null,"To submit a workload to Bacalhau you can use the ",(0,o.kt)("inlineCode",{parentName:"p"},"bacalhau docker run")," command. This allows you to pass input data volume with a ",(0,o.kt)("inlineCode",{parentName:"p"},"-v CID:path")," argument just like Docker, except the left-hand side of the argument is a ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/multiformats/cid"},"content identifier (CID)"),". This results in Bacalhau mounting a ",(0,o.kt)("em",{parentName:"p"},"data volume")," inside the container. By default, Bacalhau mounts the input volume at the path ",(0,o.kt)("inlineCode",{parentName:"p"},"/inputs")," inside the container."),(0,o.kt)("p",null,"Bacalhau also mounts a data volume to store output data. By default ",(0,o.kt)("inlineCode",{parentName:"p"},"bacalhau docker run")," creates an output data volume mounted at ",(0,o.kt)("inlineCode",{parentName:"p"},"/outputs"),". This is a convenient location to store the results of your job. See below for an example."),(0,o.kt)("p",null,"And to shard across files in the input directory, we need to pass three (optional) arguments to the command:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"sharding-base-path")," - the path to the directory you want to shard over"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"sharding-glob-pattern")," - the pattern to match files in the directory"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"sharding-batch-size")," - the number of files to pass into each job")),(0,o.kt)("h3",{id:"a-simple-video-resize-example"},"A Simple Video Resize Example"),(0,o.kt)("p",null,"In this example, you will create 72px wide video thumbnails for all the videos in the ",(0,o.kt)("inlineCode",{parentName:"p"},"inputs")," directory. The ",(0,o.kt)("inlineCode",{parentName:"p"},"outputs")," directory will contain the thumbnails for each video. We will shard by 1 video per job, and use the ",(0,o.kt)("inlineCode",{parentName:"p"},"linuxserver/ffmpeg")," container to resize the videos."),(0,o.kt)("p",null,"Note that ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/filecoin-project/bacalhau/blob/v0.2.3/cmd/bacalhau/docker_run.go#L64"},"Bacalhau overwrites the default entrypoint")," so we must run the full command after the ",(0,o.kt)("inlineCode",{parentName:"p"},"--")," argument. In this line you will list all of the mp4 files in the ",(0,o.kt)("inlineCode",{parentName:"p"},"/inputs")," directory and execute ",(0,o.kt)("inlineCode",{parentName:"p"},"ffmpeg")," against each instance."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'bacalhau docker run \\\n  --wait \\\n  --wait-timeout-secs 100 \\\n  --id-only \\\n  --sharding-base-path "/inputs" \\\n  --sharding-glob-pattern "*.mp4" \\\n  --sharding-batch-size 1 \\\n  -v Qmd9CBYpdgCLuCKRtKRRggu24H72ZUrGax5A9EYvrbC72j:/inputs \\\n  linuxserver/ffmpeg -- \\\n  bash -c \'find /inputs -iname "*.mp4" -printf "%f\\n" | xargs -I{} ffmpeg -y -i /inputs/{} -vf "scale=-1:72,setsar=1:1" /outputs/scaled_{}\'\n\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},"%env JOB_ID={job_id}\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"env: JOB_ID=c1ebae42-32b7-4d33-9885-704c7e6253b5\n")),(0,o.kt)("h2",{id:"get-results"},"Get Results"),(0,o.kt)("p",null,"Now let's download and display the result from the results directory. We can use the ",(0,o.kt)("inlineCode",{parentName:"p"},"bacalhau results")," command to download the results from the output data volume. The ",(0,o.kt)("inlineCode",{parentName:"p"},"--output-dir")," argument specifies the directory to download the results to."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir -p ./results # Temporary directory to store the results\nbacalhau get --output-dir ./results ${JOB_ID} # Download the results\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"Fetching results of job 'c1ebae42-32b7-4d33-9885-704c7e6253b5'...\nResults for job 'c1ebae42-32b7-4d33-9885-704c7e6253b5' have been written to...\n./results\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'# Copy the files to the local directory, to allow the documentation scripts to copy them to the right place\ncp results/combined_results/outputs/* ./ && rm -rf results/combined_results/outputs/*\n# Remove any spaces from the filenames\nfor f in *\\ *; do mv "$f" "${f// /_}"; done\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},"import glob\nfrom IPython.display import Video, display\nfor file in glob.glob('*.mp4'):\n    display(Video(filename=file))\n")),(0,o.kt)("video",{src:"scaled_Bird_flying_over_the_lake.mp4",controls:!0},"Your browser does not support the ",(0,o.kt)("code",null,"video")," element."),(0,o.kt)("video",{src:"scaled_Calm_waves_on_a_rocky_sea_gulf.mp4",controls:!0},"Your browser does not support the ",(0,o.kt)("code",null,"video")," element."),(0,o.kt)("video",{src:"scaled_Prominent_Late_Gothic_styled_architecture.mp4",controls:!0},"Your browser does not support the ",(0,o.kt)("code",null,"video")," element."),(0,o.kt)("video",{src:a(9774).Z,controls:!0},"Your browser does not support the ",(0,o.kt)("code",null,"video")," element."),(0,o.kt)("video",{src:a(2601).Z,controls:!0},"Your browser does not support the ",(0,o.kt)("code",null,"video")," element."),(0,o.kt)("video",{src:a(934).Z,controls:!0},"Your browser does not support the ",(0,o.kt)("code",null,"video")," element."))}u.isMDXComponent=!0},9774:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/medias/scaled_Bird_flying_over_the_lake-0c4e53b503209c78cdfc3d2df769dee2.mp4"},2601:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/medias/scaled_Calm_waves_on_a_rocky_sea_gulf-92c67314323a73a5239a62e1bf10f8cc.mp4"},934:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/medias/scaled_Prominent_Late_Gothic_styled_architecture-c169bc6d8ffb821e7e2494f9ae9ed5ee.mp4"}}]);