"use strict";(self.webpackChunkbacalhau_docs=self.webpackChunkbacalhau_docs||[]).push([[708],{1404:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>r,default:()=>h,frontMatter:()=>a,metadata:()=>l,toc:()=>c});var s=t(5893),i=t(1151);const a={sidebar_label:"StyleGAN3",sidebar_position:7},r="Generate Realistic Images using StyleGAN3 and Bacalhau",l={id:"examples/model-inference/StyleGAN3/index",title:"Generate Realistic Images using StyleGAN3 and Bacalhau",description:"stars - badge-generator",source:"@site/docs/examples/model-inference/StyleGAN3/index.md",sourceDirName:"examples/model-inference/StyleGAN3",slug:"/examples/model-inference/StyleGAN3/",permalink:"/examples/model-inference/StyleGAN3/",draft:!1,unlisted:!1,editUrl:"https://github.com/bacalhau-project/docs.bacalhau.org/blob/main/docs/examples/model-inference/StyleGAN3/index.md",tags:[],version:"current",lastUpdatedAt:1701669642,formattedLastUpdatedAt:"Dec 4, 2023",sidebarPosition:7,frontMatter:{sidebar_label:"StyleGAN3",sidebar_position:7},sidebar:"documentationSidebar",previous:{title:"Stable Diffusion - GPU",permalink:"/examples/model-inference/stable-diffusion-gpu/"},next:{title:"EasyOCR",permalink:"/examples/model-inference/EasyOCR/"}},o={},c=[{value:"TD;LR",id:"tdlr",level:2},{value:"Prerequisite",id:"prerequisite",level:2},{value:"Running StyleGAN3 locally",id:"running-stylegan3-locally",level:2},{value:"Containerize Script with Docker",id:"containerize-script-with-docker",level:2},{value:"Build the container",id:"build-the-container",level:3},{value:"Push the container",id:"push-the-container",level:3},{value:"Running a Bacalhau Job",id:"running-a-bacalhau-job",level:2},{value:"Structure of the command",id:"structure-of-the-command",level:3},{value:"Render a latent vector interpolation video",id:"render-a-latent-vector-interpolation-video",level:3},{value:"Structure of the command",id:"structure-of-the-command-1",level:3},{value:"Checking the State of your Jobs",id:"checking-the-state-of-your-jobs",level:2},{value:"Viewing your Job Output",id:"viewing-your-job-output",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"generate-realistic-images-using-stylegan3-and-bacalhau",children:"Generate Realistic Images using StyleGAN3 and Bacalhau"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{href:"https://github.com/bacalhau-project/bacalhau",children:(0,s.jsx)(n.img,{src:"https://img.shields.io/github/stars/bacalhau-project/bacalhau?style=social",alt:"stars - badge-generator"})})}),"\n",(0,s.jsx)(n.p,{children:"In this example tutorial, we will show you how to generate realistic images with StyleGAN3 and Bacalhau. StyleGAN is based on Generative Adversarial Networks (GANs), which include a generator and discriminator network that has been trained to differentiate images generated by the generator from real images. However, during the training, the generator tries to fool the discriminator, which results in the generation of realistic-looking images. With StyleGAN3 we can generate realistic-looking images or videos. It can generate not only human faces but also animals, cars, and landscapes."}),"\n",(0,s.jsx)(n.h2,{id:"tdlr",children:"TD;LR"}),"\n",(0,s.jsx)(n.p,{children:"Generative images with Bacalhau"}),"\n",(0,s.jsx)(n.h2,{id:"prerequisite",children:"Prerequisite"}),"\n",(0,s.jsxs)(n.p,{children:["To get started, you need to install the Bacalhau client, see more information ",(0,s.jsx)(n.a,{href:"https://docs.bacalhau.org/getting-started/installation",children:"here"})]}),"\n",(0,s.jsx)(n.h2,{id:"running-stylegan3-locally",children:"Running StyleGAN3 locally"}),"\n",(0,s.jsx)(n.p,{children:"To run StyleGAN3 locally, you'll need to clone the repo, install dependencies and download the model weights."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"%%bash\ngit clone https://github.com/NVlabs/stylegan3\ncd stylegan3\nconda env create -f environment.yml\nconda activate stylegan3\nwget https://api.ngc.nvidia.com/v2/models/nvidia/research/stylegan3/versions/1/files/stylegan3-r-afhqv2-512x512.pkl\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Generate an image using a pre-trained ",(0,s.jsx)(n.code,{children:"AFHQv2"})," model"]}),"\n",(0,s.jsx)(n.p,{children:"Viewing the output image"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"https://i.imgur.com/A3UExJr.png",alt:""})}),"\n",(0,s.jsx)(n.h2,{id:"containerize-script-with-docker",children:"Containerize Script with Docker"}),"\n",(0,s.jsxs)(n.p,{children:["To build your own docker container, create a ",(0,s.jsx)(n.code,{children:"Dockerfile"}),", which contains instructions to build your image."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"COPY . /scratch\n\nWORKDIR /scratch\n\nENV HOME /scratch\n"})}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsxs)(n.p,{children:["See more information on how to containerize your script/app",(0,s.jsx)(n.a,{href:"https://docs.docker.com/get-started/02_our_app/",children:"here"})]})}),"\n",(0,s.jsx)(n.h3,{id:"build-the-container",children:"Build the container"}),"\n",(0,s.jsxs)(n.p,{children:["We will run ",(0,s.jsx)(n.code,{children:"docker build"})," command to build the container;"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"docker build -t <hub-user>/<repo-name>:<tag> .\n"})}),"\n",(0,s.jsx)(n.p,{children:"Before running the command replace;"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"hub-user"})," with your docker hub username, If you don\u2019t have a docker hub account ",(0,s.jsx)(n.a,{href:"https://docs.docker.com/docker-id/",children:"follow these instructions to create docker account"}),", and use the username of the account you created"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"repo-name"})," with the name of the container, you can name it anything you want"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"tag"})," this is not required but you can use the latest tag"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"In our case"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"docker build -t jsacex/stylegan3 \n"})}),"\n",(0,s.jsx)(n.h3,{id:"push-the-container",children:"Push the container"}),"\n",(0,s.jsx)(n.p,{children:"Next, upload the image to the registry. This can be done by using the Docker hub username, repo name or tag."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"docker push <hub-user>/<repo-name>:<tag>\n"})}),"\n",(0,s.jsx)(n.p,{children:"In our case"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"docker push jsacex/stylegan3 \n"})}),"\n",(0,s.jsx)(n.h2,{id:"running-a-bacalhau-job",children:"Running a Bacalhau Job"}),"\n",(0,s.jsx)(n.p,{children:"To submit a job, run the following Bacalhau command:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"%%bash --out job_id\nbacalhau docker run \\\n--wait \\\n--id-only \\\n--gpu 1 \\\n--timeout 3600 \\\n--wait-timeout-secs 3600 \\\njsacex/stylegan3 \\\n-- python gen_images.py --outdir=../outputs --trunc=1 --seeds=2 --network=stylegan3-r-afhqv2-512x512.pkl\n"})}),"\n",(0,s.jsx)(n.h3,{id:"structure-of-the-command",children:"Structure of the command"}),"\n",(0,s.jsx)(n.p,{children:"Let's look closely at the command above:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"bacalhau docker run"}),": call to bacalhau"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"--gpu 1"}),": No of GPUs"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"jsacex/stylegan3"}),": the name and the tag of the docker image we are using"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"../outputs"}),": path to the output"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"python gen_images.py"}),": execute the script"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"--trunc=1 --seeds=2 --network=stylegan3-r-afhqv2-512x512.pkl"}),": The animation length is either determined based on the --seeds value or explicitly specified using the --num-keyframes option. When num keyframes are specified with --num-keyframes, the output video length will be 'num_keyframes*w_frames' frames."]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"render-a-latent-vector-interpolation-video",children:"Render a latent vector interpolation video"}),"\n",(0,s.jsx)(n.p,{children:"You can also run variations of this command to generate videos and other things. In the following command below, we will render a latent vector interpolation video. This will render a 4x2 grid of interpolations for seeds 0 through 31."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"%%bash --out job_id\nbacalhau docker run \\\njsacex/stylegan3 \\\n--gpu 1 \\\n--timeout 3600 \\\n--wait-timeout-secs 3600 \\\n-- python gen_video.py --output=../outputs/lerp.mp4 --trunc=1 --seeds=0-31 --grid=4x2 --network=stylegan3-r-afhqv2-512x512.pkl\n"})}),"\n",(0,s.jsx)(n.h3,{id:"structure-of-the-command-1",children:"Structure of the command"}),"\n",(0,s.jsx)(n.p,{children:"Let's look closely at the command above:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"bacalhau docker run"}),": call to bacalhau"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"--gpu 1"}),": No of GPUs"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"jsacex/stylegan3"}),": the name and the tag of the docker image we are using"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"../outputs"}),": path to the output"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"python gen_images.py"}),": execute the script"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"--trunc=1 --seeds=2 --network=stylegan3-r-afhqv2-512x512.pkl"}),": The animation length is either determined based on the ",(0,s.jsx)(n.em,{children:"--seeds"})," value or explicitly specified using the ",(0,s.jsx)(n.em,{children:"--num-keyframes"})," option. When num keyframes is specified with ",(0,s.jsx)(n.em,{children:"--num-keyframes"}),", the output video length will be 'num_keyframes",(0,s.jsxs)(n.em,{children:["w_frames' frames. If ",(0,s.jsx)(n.em,{children:"--num-keyframes"})," is not specified, the number of seeds given with  ",(0,s.jsx)(n.em,{children:"--seeds"})," must be divisible by grid size W"]}),"H (--grid).  In this case, the output video length will be '# seeds/(w*h)*w_frames' frames."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["When a job is submitted, Bacalhau prints out the related ",(0,s.jsx)(n.code,{children:"job_id"}),". We store that in an environment variable so that we can reuse it later on."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"%env JOB_ID={job_id}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"checking-the-state-of-your-jobs",children:"Checking the State of your Jobs"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Job status"}),": You can check the status of the job using ",(0,s.jsx)(n.code,{children:"bacalhau list"}),"."]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"%%bash\nbacalhau list --id-filter ${JOB_ID} --wide\n"})}),"\n",(0,s.jsxs)(n.p,{children:["When it says ",(0,s.jsx)(n.code,{children:"Completed"}),", that means the job is done, and we can get the results."]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Job information"}),": You can find out more information about your job by using ",(0,s.jsx)(n.code,{children:"bacalhau describe"}),"."]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"%%bash\nbacalhau describe ${JOB_ID}\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Job download"}),": You can download your job results directly by using ",(0,s.jsx)(n.code,{children:"bacalhau get"}),". Alternatively, you can choose to create a directory to store your results. In the command below, we created a directory and downloaded our job output to be stored in that directory."]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"%%bash\nrm -rf results && mkdir -p results\nbacalhau get $JOB_ID --output-dir results\n"})}),"\n",(0,s.jsx)(n.p,{children:"After the download has finished you should see the following contents in the results directory"}),"\n",(0,s.jsx)(n.h2,{id:"viewing-your-job-output",children:"Viewing your Job Output"}),"\n",(0,s.jsx)(n.p,{children:"To view the file, run the following command:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"%%bash\nls results/outputs\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'import IPython.display as display\ndisplay.Image("results/outputs/seed0002.png")\n'})})]})}function h(e={}){const{wrapper:n}={...(0,i.a)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},1151:(e,n,t)=>{t.d(n,{Z:()=>l,a:()=>r});var s=t(7294);const i={},a=s.createContext(i);function r(e){const n=s.useContext(a);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),s.createElement(a.Provider,{value:n},e.children)}}}]);