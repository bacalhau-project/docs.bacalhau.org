"use strict";(self.webpackChunkbacalhau_docs=self.webpackChunkbacalhau_docs||[]).push([[110],{7749:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>s,default:()=>d,frontMatter:()=>i,metadata:()=>a,toc:()=>c});var o=t(5893),r=t(1151);const i={sidebar_label:"Private Cluster",sidebar_position:5},s="Private Cluster",a={id:"next-steps/private-cluster",title:"Private Cluster",description:"It is possible to run Bacalhau completely disconnected from the main Bacalhau network so that you can run private workloads without risking running on public nodes or inadvertently sharing your data outside of your organization. The isolated network will not connect to the public Bacalhau network nor connect to a public network. To do this, we will run our network in-process rather than externally.",source:"@site/docs/next-steps/private-cluster.md",sourceDirName:"next-steps",slug:"/next-steps/private-cluster",permalink:"/next-steps/private-cluster",draft:!1,unlisted:!1,editUrl:"https://github.com/bacalhau-project/docs.bacalhau.org/blob/main/docs/next-steps/private-cluster.md",tags:[],version:"current",lastUpdatedAt:1701669642,formattedLastUpdatedAt:"Dec 4, 2023",sidebarPosition:5,frontMatter:{sidebar_label:"Private Cluster",sidebar_position:5},sidebar:"documentationSidebar",previous:{title:"Networking",permalink:"/next-steps/networking"},next:{title:"Update Checking",permalink:"/next-steps/update-checks"}},l={},c=[{value:"Initial Requester Node",id:"initial-requester-node",level:2},{value:"Compute Nodes",id:"compute-nodes",level:2},{value:"Submitting Jobs",id:"submitting-jobs",level:2},{value:"Public IPFS Network",id:"public-ipfs-network",level:2},{value:"Deploy a private cluster",id:"deploy-a-private-cluster",level:2}];function p(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,r.a)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.h1,{id:"private-cluster",children:"Private Cluster"}),"\n",(0,o.jsx)(n.p,{children:"It is possible to run Bacalhau completely disconnected from the main Bacalhau network so that you can run private workloads without risking running on public nodes or inadvertently sharing your data outside of your organization. The isolated network will not connect to the public Bacalhau network nor connect to a public network. To do this, we will run our network in-process rather than externally."}),"\n",(0,o.jsx)(n.admonition,{type:"info",children:(0,o.jsx)(n.p,{children:"A private network and storage is easier to set up, but a separate public server is better for production. The private network and storage will use a temporary directory for its repository and so the contents will be lost on shutdown."})}),"\n",(0,o.jsx)(n.h2,{id:"initial-requester-node",children:"Initial Requester Node"}),"\n",(0,o.jsxs)(n.p,{children:["The first step is to start up the initial node, which we will use as the ",(0,o.jsx)(n.code,{children:"requester node"}),". This node will connect to nothing but will listen for connections."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"bacalhau serve --node-type requester --private-internal-ipfs --peer none\n"})}),"\n",(0,o.jsx)(n.p,{children:"This will produce output similar to this:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:'16:34:17.154 | INF pkg/libp2p/host.go:69 > started libp2p host [host-id:QmWg7m5GyAhocrd8o18dtntua7dQeEHpuHxC3niRH4pnvE] [listening-addresses:["/ip4/192.168.1.224/tcp/1235","/ip4/127.0.0.1/tcp/1235","/ip4/192.168.1.224/udp/1235/quic","/ip4/127.0.0.1/udp/1235/quic","/ip6/::1/tcp/1235","/ip6/::1/udp/1235/quic"]] [p2p-addresses:["/ip4/192.168.1.224/tcp/1235/p2p/QmWg7m5GyAhocrd8o18dtntua7dQeEHpuHxC3niRH4pnvE","/ip4/127.0.0.1/tcp/1235/p2p/QmWg7m5GyAhocrd8o18dtntua7dQeEHpuHxC3niRH4pnvE","/ip4/192.168.1.224/udp/1235/quic/p2p/QmWg7m5GyAhocrd8o18dtntua7dQeEHpuHxC3niRH4pnvE","/ip4/127.0.0.1/udp/1235/quic/p2p/QmWg7m5GyAhocrd8o18dtntua7dQeEHpuHxC3niRH4pnvE","/ip6/::1/tcp/1235/p2p/QmWg7m5GyAhocrd8o18dtntua7dQeEHpuHxC3niRH4pnvE","/ip6/::1/udp/1235/quic/p2p/QmWg7m5GyAhocrd8o18dtntua7dQeEHpuHxC3niRH4pnvE"]]\n16:34:17.555 | INF cmd/bacalhau/serve.go:506 > Internal IPFS node available [NodeID:QmWg7m5G] [ipfs_swarm_addresses:["/ip4/192.168.1.224/tcp/53291/p2p/QmdCLbe2pUoGjCzffd75U8w1LTiVpSap88rNjzXsBhWkL2","/ip4/127.0.0.1/tcp/53291/p2p/QmdCLbe2pUoGjCzffd75U8w1LTiVpSap88rNjzXsBhWkL2"]]\n'})}),"\n",(0,o.jsx)(n.p,{children:"To connect another node to this private one, run the following command in your shell:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"bacalhau serve --private-internal-ipfs --peer /ip4/192.168.1.224/tcp/1235/p2p/QmWg7m5GyAhocrd8o18dtntua7dQeEHpuHxC3niRH4pnvE --ipfs-swarm-addr /ip4/192.168.1.224/tcp/53291/p2p/QmdCLbe2pUoGjCzffd75U8w1LTiVpSap88rNjzXsBhWkL2\n\nTo use this requester node from the client, run the following commands in your shell:\nexport BACALHAU_IPFS_SWARM_ADDRESSES=/ip4/192.168.1.224/tcp/53291/p2p/QmdCLbe2pUoGjCzffd75U8w1LTiVpSap88rNjzXsBhWkL2\nexport BACALHAU_API_HOST=0.0.0.0\nexport BACALHAU_API_PORT=1234\n"})}),"\n",(0,o.jsx)(n.h2,{id:"compute-nodes",children:"Compute Nodes"}),"\n",(0,o.jsx)(n.p,{children:"To connect another node to this private one, run the following command in your shell:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"bacalhau serve --private-internal-ipfs --peer /ip4/<ip-address>/tcp/1235/p2p/<peer-id> --ipfs-swarm-addr /ip4/<ip-address>/tcp/<port>/p2p/<peer-id>\n"})}),"\n",(0,o.jsx)(n.admonition,{type:"tip",children:(0,o.jsxs)(n.p,{children:["The exact command will be different on each computer and is outputted by the ",(0,o.jsx)(n.code,{children:"bacalhau serve --node-type requester ..."})," command"]})}),"\n",(0,o.jsxs)(n.p,{children:["The command ",(0,o.jsx)(n.code,{children:"bacalhau serve --private-internal-ipfs --peer ..."})," starts up a compute node and adds it to the cluster."]}),"\n",(0,o.jsx)(n.h2,{id:"submitting-jobs",children:"Submitting Jobs"}),"\n",(0,o.jsx)(n.p,{children:"To use this cluster from the client, run the following commands in your shell:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"export BACALHAU_IPFS_SWARM_ADDRESSES=/ip4/<ip-address>/tcp/<port>/p2p/<peer-id>\nexport BACALHAU_API_HOST=0.0.0.0\nexport BACALHAU_API_PORT=1234\n"})}),"\n",(0,o.jsx)(n.admonition,{type:"tip",children:(0,o.jsxs)(n.p,{children:["The exact command will be different on each computer and is outputted by the ",(0,o.jsx)(n.code,{children:"bacalhau serve --node-type requester ..."})," command"]})}),"\n",(0,o.jsxs)(n.p,{children:["The command ",(0,o.jsx)(n.code,{children:"export BACALHAU_IPFS_SWARM_ADDRESSES=..."})," sends jobs into the cluster from the command line client."]}),"\n",(0,o.jsx)(n.h2,{id:"public-ipfs-network",children:"Public IPFS Network"}),"\n",(0,o.jsx)(n.p,{children:"Instructions for connecting to the public IPFS network via the private Bacalhau cluster:"}),"\n",(0,o.jsx)(n.p,{children:"On all nodes, start ipfs:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"ipfs init\n"})}),"\n",(0,o.jsx)(n.p,{children:"Then run the following command in your shell:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"export IPFS_CONNECT=$(ipfs id |grep tcp |grep 127.0.0.1 |sed s/4001/5001/|sed s/,//g |sed 's/\"//g')\n"})}),"\n",(0,o.jsxs)(n.p,{children:["On the ",(0,o.jsx)(n.strong,{children:"first node"})," execute the following:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"export LOG_LEVEL=debug\nbacalhau serve --peer none --ipfs-connect $IPFS_CONNECT --node-type requester,compute\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Monitor the output log for:\n",(0,o.jsx)(n.code,{children:"11:16:03.827 | DBG pkg/transport/bprotocol/compute_handler.go:39 > ComputeHandler started on host QmWXAaSHbbP7mU4GrqDhkgUkX9EscfAHPMCHbrBSUi4A35"})]}),"\n",(0,o.jsxs)(n.p,{children:["On ",(0,o.jsx)(n.strong,{children:"all other nodes"})," execute the following:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"export PEER_ADDR=/ip4/<public-ip>/tcp/1235/p2p/<above>\n"})}),"\n",(0,o.jsx)(n.p,{children:"Replace the values in the command above with your own value"}),"\n",(0,o.jsx)(n.p,{children:"Here is our example:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"export PEER_ADDR=/ip4/192.18.129.124/tcp/1235/p2p/QmWXAaSHbbP7mU4GrqDhkgUkX9EscfAHPMCHbrBSUi4A35\nbacalhau serve --peer $PEER_ADDR --ipfs-connect $IPFS_CONNECT --node-type compute\n"})}),"\n",(0,o.jsx)(n.p,{children:"Then from any client set the following before invoking your Bacalhau job:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"export BACALHAU_API_HOST=address-of-first-node\n"})}),"\n",(0,o.jsx)(n.h2,{id:"deploy-a-private-cluster",children:"Deploy a private cluster"}),"\n",(0,o.jsx)(n.p,{children:"A private cluster is a network of Bacalhau nodes completely isolated from any public node.\nThat means you can safely process private jobs and data on your cloud or on-premise hosts!"}),"\n",(0,o.jsxs)(n.p,{children:["Good news. Spinning up a private cluster is really a piece of cake ","\ud83c\udf70",":"]}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["Install Bacalhau ",(0,o.jsx)(n.code,{children:"curl -sL https://get.bacalhau.org/install.sh | bash"})," on every host"]}),"\n",(0,o.jsxs)(n.li,{children:["Run ",(0,o.jsx)(n.code,{children:"bacalhau serve"}),' only on one host, this will be our "bootstrap" machine']}),"\n",(0,o.jsxs)(n.li,{children:['Copy and paste the command it outputs under the "',(0,o.jsx)(n.em,{children:"To connect another node to this private one, run the following command in your shell..."}),'" line to the ',(0,o.jsx)(n.strong,{children:"other hosts"})]}),"\n",(0,o.jsxs)(n.li,{children:['Copy and paste the env vars it outputs under the "',(0,o.jsx)(n.em,{children:"To use this requester node from the client, run the following commands in your shell..."}),'" line to a ',(0,o.jsx)(n.strong,{children:"client machine"})]}),"\n",(0,o.jsxs)(n.li,{children:["Run ",(0,o.jsx)(n.code,{children:"bacalhau docker run ubuntu echo hello"})," on the client machine"]}),"\n",(0,o.jsxs)(n.li,{children:["That's all folks! ","\ud83c\udf89"]}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["Optionally, set up ",(0,o.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Systemd",children:"systemd"})," units make Bacalhau daemons permanent, here's an example ",(0,o.jsx)(n.a,{href:"https://github.com/bacalhau-project/bacalhau/blob/main/ops/terraform/remote_files/configs/bacalhau.service",children:"systemd service file"}),"."]}),"\n",(0,o.jsxs)(n.p,{children:["Please contact us on ",(0,o.jsx)(n.a,{href:"https://bit.ly/bacalhau-project-slack/",children:"Slack"})," ",(0,o.jsx)(n.code,{children:"#bacalhau"})," channel for questions and feedback!"]})]})}function d(e={}){const{wrapper:n}={...(0,r.a)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(p,{...e})}):p(e)}},1151:(e,n,t)=>{t.d(n,{Z:()=>a,a:()=>s});var o=t(7294);const r={},i=o.createContext(r);function s(e){const n=o.useContext(i);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),o.createElement(i.Provider,{value:n},e.children)}}}]);